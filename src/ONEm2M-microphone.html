<link rel="import" href="../bower_components/polymer/polymer.html">

<dom-module id="ONEm2M-microphone">
  <template>
    <button on-tap="captureAudio">Get Audio</button>
    <canvas id="visualizer" width="640" height="160"></canvas>
  </template>

  <script>
    Polymer({
      is: 'ONEm2M-microphone',

      captureAudio: function() {
        var audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        var analyser = audioCtx.createAnalyser();
        analyser.minDecibels = -90;
        analyser.maxDecibels = -10;
        analyser.smoothingTimeConstant = 0.85;

        //var distortion = audioCtx.createWaveShaper();
        //var gainNode = audioCtx.createGain();
        //var biquadFilter = audioCtx.createBiquadFilter();

        var canvas = this.$.visualizer;
        var canvasContext = canvas.getContext("2d");

        var drawVisual;

        function visualize() {
          WIDTH = canvas.width;
          HEIGHT = canvas.height;

          analyser.fftSize = 256;
          var bufferLength = analyser.frequencyBinCount;
          console.log(bufferLength);
          var dataArray = new Uint8Array(bufferLength);

          canvasContext.clearRect(0, 0, WIDTH, HEIGHT);

          function draw() {
            drawVisual = requestAnimationFrame(draw);

            analyser.getByteFrequencyData(dataArray);

            canvasContext.fillStyle = 'rgb(0, 0, 0)';
            canvasContext.fillRect(0, 0, WIDTH, HEIGHT);

            var barWidth = (WIDTH / bufferLength) * 2.5;
            var barHeight;
            var x = 0;

            for(var i = 0; i < bufferLength; i++) {
              barHeight = dataArray[i];

              canvasContext.fillStyle = 'rgb(' + (barHeight+100) + ',50,50)';
              canvasContext.fillRect(x,HEIGHT-barHeight/2,barWidth,barHeight/2);

              x += barWidth + 1;
            }
          };

          draw();
        }

        navigator.mediaDevices.getUserMedia({audio: true}).then(function(mediaStream) {
          console.log("streamId: " + mediaStream.id);
          console.log("audioTrackId: " + mediaStream.getAudioTracks()[0].id);
          source = audioCtx.createMediaStreamSource(mediaStream);
          source.connect(analyser);
          //analyser.connect(distortion);
          //distortion.connect(biquadFilter);
          //biquadFilter.connect(gainNode);
          //gainNode.connect(audioCtx.destination);
          //console.log(gainNode.gain.value);

          visualize();
          
        }).catch(function(err) {
          console.log(err);
        })
      }
    });
  </script>
</dom-module>