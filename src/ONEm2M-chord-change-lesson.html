<!--Polymer Imports-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<!--1m2M Imports-->
<link rel="import" href="ONEm2M-chord-combo-routine.html">
<link rel="import" href="ONEm2M-chord-change-exercise.html">

<dom-module id="ONEm2M-chord-change-lesson">
  <template>
    <style>
        paper-button {
            background-color: aliceblue;
            margin-bottom: 0.1em;
        }
        .practice-schedule {
          display: inline-block;
          vertical-align: top;
        }
        .exercises {
            display: inline-block;            
        }
    </style>          
    <ONEm2M-chord-combo-routine id="routine" class="practice-schedule" combos="{{_combos}}" combo-count="{{exerciseCount}}" active-combo-index="{{activeExerciseIndex}}"  on-iron-select="_combosChanged"></ONEm2M-chord-combo-routine>
    <div class="exercises">
        <paper-button on-tap="startLesson">Start Lesson</paper-button>
        <paper-button on-tap="saveLesson">Save Lesson</paper-button>
        </br>        
        <template is="dom-repeat" items="{{exercises}}">            
            <ONEm2M-chord-change-exercise id="exercise{{item}}"></ONEm2M-chord-change-exercise>
        </template>
    </div>
  </template>

  <script>
    Polymer({
      is: 'ONEm2M-chord-change-lesson',
      properties: {
        _combos: {
            type: Array,
            notify: true,
            observer: "_combosChanged"
        },
        activeExerciseIndex: {
            type: Number,
            notify: true,
            observer: "_activeExerciseChanged"
        },
        exerciseCount: {
            type: Number,
            notify: true,
            observer: "_exerciseCountChanged"
        },
        exercises: {
            type: Array,
            value: [],
            notify: true
        }
      },
      //lifecycle callbacks
      attached: function() {
        this.exerciseCount = 5;
      },
      //_private members
      _activeExerciseChanged: function() {          
          
      },
      _combosChanged: function(e) {
          if (e.path) {
            for (let i = 0; i < e.path.length; i++) {                
                let id = e.path[i].id;
                if (id) {
                    if (id.includes("combo") && id.includes("Chord")) {
                        let comboIndex = Number(id.substring(5,6));
                        let chordIndex = Number(id.substring(id.length - 1, id.length));
                        let exercise = this.$$("#exercise" + comboIndex);
                        if (exercise) {                            
                            exercise["chord" + chordIndex] = e.detail.item.innerText;
                        }
                    }
                }
            }
          }
      },
      _exerciseCountChanged: function() {        
        this.newLesson();        
      },
      
      //public members
      newLesson: function() {        
        let exercises = [];
        for (let i=0; i < this.exerciseCount; i++) {
          exercises.push(i);
        }
        this.exercises = exercises;
        let routine = this.$.routine;
        let self = this;
        setTimeout(function() {
            for (let i=0; i< self.exerciseCount; i++) {
                let exercise = self.$$("#exercise" + i);
                if (exercise) {                    
                    exercise.chord1 = routine.combos[i].chord1;
                    exercise.chord2 = routine.combos[i].chord2;
                }
            }
        }, 1000); 
      },
      saveLesson: function() {
          //TODO: save history
      },
      startLesson: function() {
        let self = this;
        self.$.routine.nextCombo();            
        self.$$("#exercise" + self.activeExerciseIndex).isActive = true;
        let practiceSession = setInterval(function() {            
            if (self.activeExerciseIndex == -1) {
                clearInterval(practiceSession);
            } else {
                self.$$("#exercise" + self.activeExerciseIndex).isActive = false;
                //TODO: put exercise details in sessionStorage so they can be moved to localStorage later
                self.$.routine.nextCombo();
                if (self.activeExerciseIndex != -1) {
                    self.$$("#exercise" + self.activeExerciseIndex).isActive = true;
                }
            }
        },63000);
      }
    });
  </script>
</dom-module>